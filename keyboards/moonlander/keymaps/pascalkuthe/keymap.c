// vim: nowrap

#include "keycodes.h"
#include "keymap_us.h"
#include "quantum_keycodes.h"
#include "send_string_keycodes.h"
#include QMK_KEYBOARD_H
#include "version.h"
#include "features/achordion.h"

// Home row mods
#define HOME_A KC_A
#define HOME_R LALT_T(KC_R)
#define HOME_S LCTL_T(KC_S)
#define HOME_T KC_T
#define HOME_O KC_O
#define HOME_I LALT_T(KC_I)
#define HOME_E LCTL_T(KC_E)
#define HOME_Z LGUI_T(KC_Z)
#define HOME_N KC_N
#define HOME_SC KC_UNDERSCORE
#define HOME_SP LT(L_SYMB, KC_SPACE)
#define HOME_BSP LT(L_NAV, KC_BACKSPACE)

enum custom_keycodes {
    AE = SAFE_RANGE,
    OE,
    UE,
    SS,
    UPDIR,
    SCOPE,
};



const key_override_t dot_key_override =
    ko_make_basic(MOD_MASK_SHIFT, KC_DOT, KC_EXCLAIM);  // Shift . is ?
const key_override_t comm_key_override =
    ko_make_basic(MOD_MASK_SHIFT, KC_COMM, KC_QUES); // Shift , is !

const key_override_t** key_overrides = (const key_override_t*[]){
    &dot_key_override,
    &comm_key_override,
    NULL
};

int shift_down = 0; // record last checked status of shift
// 0 - shift not down
// 1 - shift down
// 2 - shift down, but another key already pressed

bool process_record_user(uint16_t keycode, keyrecord_t* record) {
    if (!process_achordion(keycode, record)) {
        return false;
    }
    if (keycode == KC_LSFT) { // key is shift
        if (record->event.pressed) { // set shift status
            switch(shift_down){
                case 4:
                    caps_word_on();
                    shift_down = 0;
                    break;
                default: 
                    caps_word_off();
                    register_code(KC_LEFT_SHIFT);
                    shift_down = 1;
                    break;
        
            }
        }else{
            switch (shift_down) {
                case 1:
                    shift_down = 4;
                    break;
                case 2:
                    unregister_code(KC_LEFT_SHIFT);
                    shift_down = 0;
                    break;
            }
        }
        return false;
    } else if (shift_down == 1) { // key is not shift, and shift was pressed 1 keys ago
        shift_down = 2; // unset shift next time
    } else if (shift_down == 4) { // key is not shift, and shift was pressed 1 keys ago
        shift_down = 5; // unset shift next time
    } else if (shift_down == 5) { // key is not shift, shift was pressed 2 keys ago
        shift_down = 0; // reset shift to unpressed
        unregister_code(KC_LSFT);
    }
    switch (keycode) {
        case AE:
            if (record->event.pressed) {
                // when keycode QMKURL is pressed
                SEND_STRING(SS_RALT("a\""));
            } else {
                // when keycode QMKURL is released
            }
            break;
        case OE:
            if (record->event.pressed) {
                // when keycode QMKURL is pressed
                SEND_STRING(SS_RALT("o\""));
            } else {
                // when keycode QMKURL is released
            }
            break;
        case UE:
            if (record->event.pressed) {
                // when keycode QMKURL is pressed
                SEND_STRING(SS_RALT("u\""));
            } else {
                // when keycode QMKURL is released
            }
            break;
        case SS:
            if (record->event.pressed) {
                // when keycode QMKURL is pressed
                SEND_STRING(SS_RALT("ss"));
            } else {
                // when keycode QMKURL is released
            }
            break;
        case UPDIR:
            if (record->event.pressed) {
                // when keycode QMKURL is pressed
                SEND_STRING("../");
            } else {
                // when keycode QMKURL is released
            }
            break;
        case SCOPE:
            if (record->event.pressed) {
                // when keycode QMKURL is pressed
                SEND_STRING("::");
            } else {
                // when keycode QMKURL is released
            }
            break;
    }

    return true;
}

enum layers {
    L_BASE,
    L_SYMB,
    L_NUM,
    L_UNICODE,
    L_NAV,
    L_SYS,
};

// clang-format off
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
  [L_BASE] = LAYOUT_moonlander(
    // _________________________________________________________________________________________________________________________________________________________________________________
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
         KC_DELETE,       KC_8,          KC_9,        KC_0,    KC_5,       KC_6,       KC_HOME,       KC_END,      KC_7,     KC_1,     KC_2,       KC_3,         KC_4,       KC_RIGHT_ALT,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
         KC_DELETE,        KC_Q,          KC_W,        KC_F,    KC_P,      KC_B,       KC_AMPR,      KC_PIPE,      KC_J,     KC_L,     KC_U,       KC_Y,         KC_QUOT,   KC_BACKSLASH,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
        KC_LSFT,    HOME_A,        HOME_R,      HOME_S,  HOME_T,      KC_G,      KC_LBRC,      KC_RBRC,       KC_M,    HOME_N,   HOME_E,      HOME_I,      HOME_O,   KC_LSFT,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
         KC_COMMA,        HOME_Z,        KC_X,        KC_C,    KC_D,       KC_V,                                   KC_K,     KC_H,    KC_LPRN,    KC_RPRN,      HOME_SC,    KC_DOT,
    //|______________|______________|______________|________|________|______________|                           |_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
       KC_LEFT_GUI,    KC_LEFT_GUI,   KC_LEFT_GUI,  KC_LBRC,LT(L_SYMB,KC_TAB),G(KC_LEFT),                   G(KC_RIGHT), KC_ENTER,   KC_RCBR,  KC_SLASH,     KC_SLASH,    KC_SLASH,
    //|______________|______________|______________|________|________|______________|_________       ___________|_________|________|__________|_____________|_____________|_____________|
    //                                |                  |                |                   |     |           |                  |                |
                                           HOME_SP,        LT(L_NUM, KC_ESC), KC_LEFT_ALT,           TG(L_UNICODE),  KC_DELETE,      HOME_BSP
    //                                |__________________|________________|___________________|     |___________|__________________|________________|
  ),

  [L_NAV] = LAYOUT_moonlander(
    // _________________________________________________________________________________________________________________________________________________________________________________
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,       _______,        _______,   _______, _______,    _______,      _______,     _______,     _______, _______,  _______,     _______,     _______,      _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,        _______,       _______,   _______, _______,    _______,      _______,     _______,      _______, KC_PAGE_UP,KC_PGDN, KC_MS_WH_UP, KC_MS_WH_DOWN,  _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,        _______,       _______,   _______, _______,    _______,       _______,    _______,     KC_ENTER,  KC_LEFT,  KC_DOWN,    KC_UP,       KC_RIGHT,     _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
          _______,        _______,       _______,   _______, _______,    _______,                              KC_MS_BTN1,KC_MS_LEFT,KC_MS_DOWN,  KC_MS_UP,   KC_MS_RIGHT,   _______,
    //|______________|______________|______________|________|________|______________|                           |_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
          _______,       _______,        _______,   _______, _______,    _______,                                 _______, KC_MS_BTN2,  _______,    _______,      _______,      _______,
    //|______________|______________|______________|________|________|______________|_________       ___________|_________|________|__________|_____________|_____________|_____________|
    //                                |                  |                |                   |     |           |                  |                |
                                            _______,           _______,          _______,              _______,       _______,           _______
    //                                |__________________|________________|___________________|     |___________|__________________|________________|
  ),
  [L_SYMB] = LAYOUT_moonlander(
    // _________________________________________________________________________________________________________________________________________________________________________________
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
         _______,        KC_F8,          KC_F9,      KC_F10,    KC_F5,     KC_F6,       _______,     _______,      KC_F7,     KC_F1,     KC_F2,       KC_F3,         KC_F4,       _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,       KC_GRAVE,      KC_LABK,     KC_RABK,  KC_DQUO,  UPDIR,       _______,      _______,  KC_DOLLAR, KC_AMPR, KC_LCBR,    KC_RCBR,      KC_GRAVE,        _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          KC_LEFT_ALT,    KC_EXLM,      KC_MINS,     KC_PLUS, KC_EQL,    KC_HASH,       _______,      _______,     KC_PIPE, KC_COLN,  KC_LPRN,    KC_RPRN,      KC_DOT,       KC_PERC,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
         _______,        KC_AT,      KC_SLSH,     KC_ASTR, KC_CIRC,       KC_COMM,                               KC_TILDE, KC_SEMICOLON, KC_LBRC,   KC_RBRC,     KC_CIRC,    _______,
    //|______________|______________|______________|________|________|______________|                           |_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
          _______,       _______,       _______,    _______, _______,   _______,                                  _______,  _______,  _______,    _______,      _______,       _______,
    //|______________|______________|______________|________|________|______________|_________       ___________|_________|________|__________|_____________|_____________|_____________|
    //                                |                  |                |                   |     |           |                  |                |
                                            _______,           _______,          _______,             _______,      _______,         KC_BACKSPACE
    //                                |__________________|________________|___________________|     |___________|__________________|________________|
  ),
  [L_NUM] = LAYOUT_moonlander(
    // _________________________________________________________________________________________________________________________________________________________________________________
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,       _______,        _______,   _______, _______,    _______,      _______,       _______,    _______, _______,  _______,      _______,     _______,      _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,        KC_MINUS,      KC_7,       KC_8,    KC_9,    KC_HASH,        _______,       _______,    _______, KC_PERC,  _______,     _______,      _______,      _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,        KC_EQL,        KC_4,       KC_5,    KC_6,     KC_0,      _______,       _______,    _______, KC_AMPR,  _______,     _______,      _______,      _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
          _______,        KC_PLUS,       KC_1,       KC_2,    KC_3,    KC_BACKSLASH,                                  _______, KC_ASTERISK, _______,     _______,      _______,      _______,
    //|______________|______________|______________|________|________|______________|                           |_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
          _______,       _______,        _______,   _______, _______,    _______,                                _______,KC_LEFT_GUI,_______,     _______,      _______,      _______,
    //|______________|______________|______________|________|________|______________|_________       ___________|_________|________|__________|_____________|_____________|_____________|
    //                                |                  |                |                   |     |           |                  |                |
                                            _______,         _______,           _______,               _______,       _______,          _______
    //                                |__________________|________________|___________________|     |___________|__________________|________________|
  ),
  [L_UNICODE] = LAYOUT_moonlander(
    // _________________________________________________________________________________________________________________________________________________________________________________
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
           _______,       _______,       _______,   _______, _______,    _______,      _______,       _______,    _______, _______,  _______,     _______,      _______,      _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
           OE,           _______,       _______,   _______, _______,    _______,      _______,       _______,    _______,  _______,  _______,    _______,        UE,         AE,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
           _______,        _______,     _______,   _______,  _______,    _______,      _______,       _______,    _______,  _______,  _______,     _______,     _______,      _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
           _______,       _______,       _______,   _______, _______,    _______,                                 _______, _______,    AE,          OE,           SS,        _______,
    //|______________|______________|______________|________|________|______________|                           |_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
           _______,       _______,       _______,   _______, _______,    _______,                                 _______, _______,    AE,          OE,           SS,        _______,
    //|______________|______________|______________|________|________|______________|_________       ___________|_________|________|__________|_____________|_____________|_____________|
    //                                |                  |                |                   |     |           |                  |                |
                                            _______,          _______,     _______,         _______,        _______,          _______
    //                                |__________________|________________|___________________|     |___________|__________________|________________|
  ),
  [L_SYS] = LAYOUT_moonlander(
    // _________________________________________________________________________________________________________________________________________________________________________________
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,       _______,       _______,    _______, _______,     _______,     _______,       _______,    _______, _______,  _______,     _______,      _______,      _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,       _______,       G(KC_7),     G(KC_8), G(KC_9),     _______,     _______,     _______,      _______, G(KC_AMPR),G(KC_ASTR), G(KC_LPRN),   _______,      _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |           | |             |         |        |          |             |             |             |
          _______,       G(KC_Q),       G(KC_4),     G(KC_5), G(KC_6),    _______,     _______,       _______,    _______, G(KC_DLR),G(KC_PERC), G(KC_CIRC), G(KC_SEMICOLON),     _______,
    //|______________|______________|______________|________|________|______________|___________| |_____________|_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
          _______,       _______,       G(KC_1),     G(KC_2), G(KC_3),     _______,                                _______, G(KC_EXCLAIM), G(KC_AT), G(KC_HASH), _______,      _______,
    //|______________|______________|______________|________|________|______________|                           |_________|________|__________|_____________|_____________|_____________|
    //|              |              |              |        |        |              |                           |         |        |          |             |             |             |
          _______,       _______,       _______,    _______, _______,  LSG(KC_PAGE_UP),                LSG(KC_PAGE_DOWN), _______,  _______,     _______,      _______,      _______,
    //|______________|______________|______________|________|________|______________|_________       ___________|_________|________|__________|_____________|_____________|_____________|
    //                                |                  |                |                   |     |           |                  |                |
                                       G(KC_PAGE_UP),       _______,          _______,               _______,      _______,        G(KC_PAGE_DOWN)
    //                                |__________________|________________|___________________|     |___________|__________________|________________|
  ),
};
// clang-format on


uint16_t get_quick_tap_term(uint16_t keycode, keyrecord_t* record) {
    // If you quickly hold a tap-hold key after tapping it, the tap action is
    // repeated. Key repeating is useful e.g. for Vim navigation keys, but can
    // lead to missed triggers in fast typing. Here, returning true means we
    // instead want to "force hold" and disable key repeating.
    switch (keycode) {
        // Repeating is useful for Vim navigation keys.
        case HOME_SP:
        case HOME_BSP:
            return 120; // Enable key repeating.
        default:
            return 0; // Otherwise, force hold and disable key repeating.
    }
}

void matrix_scan_user(void) {
    achordion_task();
}

uint16_t achordion_timeout(uint16_t tap_hold_keycode) {
    return 20000; // Otherwise use a timeout of 800 ms.
}

extern rgb_config_t rgb_matrix_config;

const uint8_t PROGMEM ledmap[][RGB_MATRIX_LED_COUNT][3] = {
    [L_BASE] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {123, 218, 204}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {123, 218, 204}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {123, 218, 204}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {123, 218, 204}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {131, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {123, 218, 204}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},

    [L_SYMB] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 245, 245}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {123, 218, 204}, {123, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {123, 218, 204}, {123, 218, 204}, {123, 218, 204}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {74, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {74, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {131, 255, 255}, {131, 255, 255}, {131, 255, 255}, {131, 255, 255}, {0, 0, 0}, {131, 255, 255}, {131, 255, 255}, {131, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {131, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},

    [L_NUM] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {131, 255, 255}, {131, 255, 255}, {131, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {74, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {74, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {74, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {123, 218, 204}, {123, 218, 204}, {123, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 245, 245}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {123, 218, 204}, {123, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},

    [L_NAV] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {131, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {131, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {131, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {131, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {0, 0, 0}, {0, 245, 245}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},

    [L_UNICODE] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {74, 255, 206}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {74, 255, 206}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {123, 218, 204}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 206}, {0, 245, 245}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 206}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {24, 255, 255}, {24, 255, 255}, {24, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},

    [L_SYS] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {131, 255, 255}, {131, 255, 255}, {131, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {74, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {74, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {74, 255, 255}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {123, 218, 204}, {123, 218, 204}, {123, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {74, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 245, 245}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {123, 218, 204}, {123, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
};

void set_layer_color(int layer) {
    for (int i = 0; i < RGB_MATRIX_LED_COUNT; i++) {
        HSV hsv = {
            .h = pgm_read_byte(&ledmap[layer][i][0]),
            .s = pgm_read_byte(&ledmap[layer][i][1]),
            .v = pgm_read_byte(&ledmap[layer][i][2]),
        };
        if (!hsv.h && !hsv.s && !hsv.v) {
            rgb_matrix_set_color(i, 0, 0, 0);
        } else {
            RGB   rgb = hsv_to_rgb(hsv);
            float f   = (float)rgb_matrix_config.hsv.v / UINT8_MAX;
            rgb_matrix_set_color(i, f * rgb.r, f * rgb.g, f * rgb.b);
        }
    }
}

void keyboard_post_init_user(void) {
    rgb_matrix_enable();
}

bool rgb_matrix_indicators_user(void) {
    if (keyboard_config.disable_layer_led) {
        return false;
    }

    switch (biton32(layer_state)) {
        case L_BASE:
            set_layer_color(L_BASE);
            break;
        case L_SYMB:
            set_layer_color(L_SYMB);
            break;
        case L_NUM:
            set_layer_color(L_NUM);
            break;
        case L_NAV:
            set_layer_color(L_NAV);
            break;
        case L_UNICODE:
            set_layer_color(L_UNICODE);
            break;
        default:
            if (rgb_matrix_get_flags() == LED_FLAG_NONE) rgb_matrix_set_color_all(0, 0, 0);
            break;
    }

    return false;
}

bool achordion_chord(uint16_t tap_hold_keycode, keyrecord_t* tap_hold_record, uint16_t other_keycode, keyrecord_t* other_record) {
    // Exceptionally consider the following chords as holds, even though they
    // are on the same hand
    switch (tap_hold_keycode) {
        case HOME_SP:
            return true;
        case HOME_BSP:
            return other_keycode != HOME_SP;
    }

    // Otherwise, follow the opposite hands rule.
    return achordion_opposite_hands(tap_hold_record, other_record);
}